

### 1. 共通開発ルール仕様書

```markdown
# 共通開発ルール仕様書
 
**計画書バージョン:** 1.2
**更新日時:** 2025.09.03
 
## 概要
 
このファイルはAI Agentにおいて、開発プロジェクトで共通に適用される**開発ルール**を定義します。
各プロジェクト固有の設計情報は`docs/`ディレクトリに配置してください。
 
## システム開発のルール
 
### CLAUDE.mdの管理
 
- プロジェクトルートに`CLAUDE.md`ファイルを配置し、AI Agentが参照する**知識情報**を記録
- プロジェクトの概要、アーキテクチャ、依存関係、実行方法は、別ファイル**設計書**(`docs/design-specification.md`)を参照
- 本ファイルは、最新の変更に合わせて継続的に更新（バージョン管理必須）
 
### タスク管理のルール
 
- **すべてのタスクはTodoWriteツールで管理必須**
- **タスク開始時：status を "in_progress" に変更**
- **タスク完了時：status を "completed" に即座変更**
- **TodoWrite使用なしでの開発は禁止**
- 機能実装前に明確な計画を立案し、実装手順を**開発計画書**として文書化（`docs/project-plan.md`）すること
- 複雑なタスクは小さなステップに分割し、段階的に実装
 
### ファイル構成規則
 
- プロジェクト構造は標準的なディレクトリ構成に従う
 
  ```text
  project/
  ├── CLAUDE.md                    # AI Agent用の指示書
  ├── README.md                    # プロジェクト説明
  ├── DEV_RULES.md                    # 開発に関するルール
  ├── requirements.txt             # 依存関係（Python）
  ├── pyproject.toml               # プロジェクト設定（Poetry使用時）
  ├── .env.example                 # 環境変数テンプレート
  ├── src/                        # ソースコード
  ├── tests/                      # テストコード
  ├── docs/                       # ドキュメント
  │   ├── design-specification.md  # **設計書**: 必須 この設計書に従って開発すること
  │   └── project-plan.md         # **開発計画書**: 必須 この開発計画に従って開発すること
  ├── scripts/                    # スクリプト類
  └── samples/                      # サンプルexcelファイル
  ```
 
### 環境設定
 
- 開発は仮想環境でおこなうことを必須とし、開発PCの環境を汚さないこと
- Pythonプロジェクトは仮想環境「.venv」を必須とする
- 開発環境の統一化のため`.devcontainer`または`docker-compose.yml`を提供
- 環境変数は`.env`ファイルで管理し、`.env.example`でテンプレートを提供
- 依存関係は明確に定義し、バージョン固定を行う
 
### ドキュメント管理
 
- コード変更時は関連ドキュメントも同時に更新
- API仕様はOpenAPI/Swagger形式で管理
- 設計書、操作手順書は`docs/`ディレクトリで一元管理
 
## 開発体制
 
### 役割分担
 
プロジェクトの**開発計画**は、プロダクトマネージャによってタスクを担当者で分割する
 
| 役割                     | 主な責務                                               |
| ------------------------ | ------------------------------------------------------ |
| プロダクトマネージャー   | 全体管理、仕様決定、品質統括、デザインレビュー         |
| バックエンドエンジニア   | データ層、Chatbot関連、Excel操作など |
| フロントエンドエンジニア | UI関連      |
| QAエンジニア             | テスト戦略策定、品質保証、テスト作成・実施             |
 
## コーディング規約
 
### TDD実装手順（**必須：twada tdd**）
 
1. **機能仕様を明確化**
2. **テストケース作成（Red フェーズ）**
3. **最小実装でテスト通過（Green フェーズ）**
4. **リファクタリング（Refactor フェーズ）**
5. **使用ツール：pytest（Python）、jest（JavaScript）**
 
### 開発手法
 
- **継続的インテグレーション（CI）** を導入し、コードプッシュ時の自動テスト実行を行う
- **コードレビュー** を必須とし、最低1名以上のレビューを経てマージする
 
### コード品質
 
- **命名規則:**
  - 関数・変数名：snake_case（例：`calculate_string_length`）
  - クラス名：PascalCase（例：`StringLengthCalculator`）
  - 定数：UPPER_SNAKE_CASE（例：`MAX_STRING_LENGTH`）
- **コメント:**
  - 複雑なロジックには日本語でコメントを記述
  - 関数・クラスにはdocstringを記述
- **型ヒント:** すべての関数の引数・戻り値に型ヒントを付与
- **静的解析:** flake8、mypy、black等のツールを導入し、コード品質を保持
 
### エラーハンドリング
 
- **例外処理:** 適切な例外クラスを使用し、具体的なエラーメッセージを設定
- **ログ出力:** 構造化ログ（JSON形式）でタイムスタンプ、ログレベル、メッセージを記録
- **リトライ機構:** 外部API呼び出しには適切なリトライ機構を実装
 
### ユーザーエクスペリエンス
 
- **進捗表示:** 時間のかかる処理（3秒以上）は進捗状況を表示し、ユーザーに処理状況を伝える
- **処理結果表示:** すべてのユーザー操作に対して、処理結果（成功・失敗とその理由）を明確に表示
- **フィードバック:** ユーザーアクションに対する即座のレスポンス（ボタン押下時の視覚的変化等）を提供
- **エラーメッセージ:** ユーザーが理解しやすい日本語でエラー内容と対処方法を表示
- **操作ガイダンス:** 複雑な操作には適切なヘルプテキストや操作手順を表示
 
### セキュリティ
 
- **入力検証:** すべてのユーザー入力に対してサニタイズとバリデーションを実施
- **認証・認可:** 必要に応じてJWT等を使用した認証機構を実装
- **CORS設定:** 適切なオリジン制限を設定
- **レート制限:** API呼び出し頻度制限を実装
- **セキュリティヘッダー:** HTTPS強制、XSS対策等のセキュリティヘッダーを設定
 
### パフォーマンス
 
- **データベース:** インデックスを適切に設定し、N+1問題を回避
- **キャッシュ:** Redis等を使用した適切なキャッシュ戦略を実装
- **非同期処理:** I/O集約的な処理には非同期処理を採用
 
### 保守性
 
- **依存関係管理:** requirements.txt または poetry.lock で依存関係を固定
- **設定管理:** 環境変数を使用し、設定ファイルで環境別設定を分離
- **ドキュメント:** README.md、API仕様書を最新状態に保持
```

---

### 2. 設計書 (`docs/design-specification.md`)

```markdown
# デモ機予約管理Bot 設計書

**設計書バージョン:** 5.0
**バージョン名:** Chatbotステートマシン実装版
**更新日時:** 2025.09.03

## 1. システムアーキテクチャ

### 1.1. 概要
ユーザーのPC上で完結するWebアプリケーションを構築する。Chatbotの対話ロジックは、バックエンドのPythonサーバーに実装されたステートマシンによって管理される。フロントエンドは、現在の対話状態（State）を保持し、ユーザーの入力をサーバーに送信する役割を担う。

### 1.2. コンポーネント構成

```mermaid
graph TD
    subgraph "Local PC"
        subgraph "User Interface (Web Browser)"
            Frontend[HTML/CSS/JavaScript]
        end

        subgraph "Application Server"
            PythonServer[Python Web Server (Flask/FastAPI)]
        end

        subgraph "Data Storage"
            Excel[Local Excel File]
        end

        Frontend -- API Call (HTTP) --> PythonServer
        PythonServer -- Read/Write --> Excel
    end
```

### 1.3. データフロー
1.  **ユーザー**がWebブラウザでアプリケーションにアクセスします。
2.  **フロントエンドJS**は、`state`が`null`の状態でバックエンドの `POST /api/chat` へ最初のリクエストを送信します。
3.  **バックエンド**は、`state`が`null`であることを検知し、最初の挨拶と名前を尋ねる質問、そして次の状態 `AWAITING_USER_INFO_NAME` を返します。
4.  **フロントエンドJS**は、応答メッセージを画面に表示し、`state`を `AWAITING_USER_INFO_NAME` に更新して`sessionStorage`に保存します。
5.  **ユーザー**が名前を入力すると、**フロントエンドJS**は、保存しておいた`state`と入力された名前を付けて、再度 `POST /api/chat` へリクエストを送信します。
6.  **バックエンド**は、現在の`state`に応じた処理（この場合は内線番号を尋ねる処理）を行い、次の応答と`next_state`を返します。
7.  このプロセスを繰り返すことで、対話が進行します。

---

## 2. データモデル設計 (Excel)

*   **ファイル場所**: アプリケーションと同一階層の `data/` ディレクトリなど
*   **ファイル名**: `デモ機予約管理表.xlsx`

### 2.1. カレンダーシート
*   **シート名**: `yy年M月`形式 (例: `25年9月`, `25年10月`)
*   **テーブル化**: このシートは「テーブルとして書式設定」を使用しません。
*   **構造**:
    *   **日付ヘッダー (8行目)**: **C8セル**から右に向かって、月の日を記載 (`1`, `2`, `3`...)。
    *   **デモ機名リスト (B列)**: **B9セル**から下に向かって、デモ機名を記載。
    *   **予約データ領域**: **C9セル**から右下の範囲。デモ機（行）と日付（列）が交差するセルに予約フラグ"C"等を格納します。

### 2.2. 予約ログシート
*   **シート名**: `予約ログ`
*   **テーブル化**: このシートは扱いやすさのため、A1セルから始まる範囲をテーブルとして設定します。
*   **テーブル名**: `BookingLog`
*   **構造**:

| 列ヘッダ名 | データ型 | 説明 |
| :--- | :--- | :--- |
| 予約ID | 文字列 | 一意のID |
| 予約日時 | 文字列 | 日本時間(JST) `yyyy-MM-ddTHH:mm:ss` |
| **予約者名** | 文字列 | **ユーザーが入力した名前** |
| **内線番号** | 文字列 | **ユーザーが入力した内線番号** |
| **職番** | 文字列 | **ユーザーが入力した職番** |
| デモ機名 | 文字列 | 予約されたデモ機名 |
| 予約開始日| 日付 | `yyyy-MM-dd` |
| 予約終了日| 日付 | `yyyy-MM-dd` |
| ステータス | 文字列 | "予約中" |

---

## 3. API設計 (ローカルサーバー)

### 3.1. Chatbot対話API
すべての対話は、この単一のエンドポイントで処理される。

*   **エンドポイント:** `POST /api/chat`
*   **機能:** ユーザーの入力と現在の対話状態を受け取り、Botの応答と次の状態を返す。
*   **リクエストボディ (JSON):**
    ```json
    {
      "text": "FEデモ機を借りたい",    // ユーザーが入力したテキスト (初回はnull)
      "state": "AWAITING_COMMAND",    // フロントエンドが保持する現在の状態 (初回はnull)
      "user_info": {                  // フロントエンドが保持する入力済みのユーザー情報
        "name": "山田太郎",
        "extension": "1234",
        "employee_id": "56789"
      },
      "context": {} // 予約途中など、一時的な情報を保持するオブジェクト
    }
    ```
*   **レスポンスボディ (JSON):**
    ```json
    {
      "reply_text": "FEデモ機ですね。いつからいつまで利用しますか？", // Botの返信
      "next_state": "AWAITING_DATES", // 次の対話の状態
      "user_info": { ... }, // 更新されたユーザー情報
      "context": { "device_type": "FEデモ機" } // 更新された一時情報
    }
    ```

### 3.2. 内部ロジック
`POST /api/chat` は、内部的に以下のロジックモジュールを呼び出す。
*   Excel操作モジュール（在庫確認、予約実行、キャンセル実行）
*   自然言語解釈モジュール（ユーザーの入力から意図やキーワードを抽出）

---

## 4. フロントエンド設計

*   **UIコンポーネント:** チャット画面、入力欄、送信ボタン
*   **状態管理:**
    *   JavaScriptは、以下の情報を `sessionStorage` で永続化する。
        *   `state`: 現在の対話状態 (例: `AWAITING_COMMAND`)
        *   `user_info`: 入力済みのユーザー情報オブジェクト
        *   `context`: 予約途中のデモ機名など、一時的な情報
    *   ユーザーがメッセージを送信するたびに、これらの情報を `POST /api/chat` のリクエストに含める。
    *   APIからの応答を受け取ると、`sessionStorage` の情報をレスポンスの内容で更新する。

---

## 5. 開発環境
*   **言語:** Python 3.9+
*   **主要ライブラリ:** Flask, openpyxl, python-dotenv
*   **ツール:** pytest

```

---

### 3. 開発計画書 (`docs/project-plan.md`)

```markdown
# 開発計画書

**計画書バージョン:** 4.0
**更新日時:** 2025.09.03
**対象プロジェクト:** デモ機予約管理Bot 開発 (Webブラウザ版)

## 1. 概要
本計画書は、ローカルのWebブラウザで動作する「デモ機予約管理Bot」のマイルストーンとタスクを定義する。

## 2. 開発マイルストーン

| マイルストーン ID | マイルストーン名 | 主要目的 |
| :--- | :--- | :--- |
| **M1** | **環境構築と基本設計** | 開発環境を構築し、ステートマシン方式に基づく画面とAPIの基本設計を完了させる。 |
| **M2** | **バックエンドChatbotロジック実装** | 対話の中心となる`/api/chat`エンドポイントと、ステートマシンに基づく対話制御ロジックを実装する。 |
| **M3** | **Webフロントエンド実装と結合** | フロントエンドのUIと状態管理ロジックを実装し、バックエンドと完全に連携させる。 |
| **M4** | **総合テストとパッケージング** | ブラウザからExcelまでの一連の動作をテストし、利用者が簡単に起動できる形式にまとめる。 |
| **M5** | **リリースと運用** | 利用者への展開と運用を開始する。 |

## 3. タスクリストと担当者割り当て

### M1: 環境構築と基本設計

| Task ID | タスク内容 | 担当者 |
| :--- | :--- | :--- |
| M1-T1 | `design-specification.md` (v5.0) のレビューと承認 | プロダクトマネージャー |
| M1-T2 | Pythonバックエンド開発環境のセットアップ (`.venv`作成) | バックエンドエンジニア |
| M1-T3 | Webフロントエンド開発環境の準備 (HTML/CSS/JSファイル構成) | フロントエンドエンジニア |
| M1-T4 | Chatbotの全対話状態（State）の洗い出しと定義 | バックエンドエンジニア |
| M1-T5 | `/api/chat` のTDDテストケース作成 (pytest) | バックエンドエンジニア |

### M2: バックエンドChatbotロジック実装

| Task ID | タスク内容 | 担当者 |
| :--- | :--- | :--- |
| M2-T1 | 【TDD】Flaskサーバーと`/api/chat`エンドポイントの雛形作成 | バックエンドエンジニア |
| M2-T2 | 【TDD】Excel操作モジュールの実装（在庫確認、予約実行など） | バックエンドエンジニア |
| M2-T3 | 【TDD】ユーザー情報収集フェーズのステートマシンロジック実装 | バックエンドエンジニア |
| M2-T4 | 【TDD】予約受付フェーズのステートマシンロジック実装 | バックエンドエンジニア |
| M2-T5 | 【TDD】キャンセル受付フェーズのステートマシンロジック実装 | バックエンドエンジニア |
| M2-T6 | バックエンド全体のコードレビューと単体テスト完了 | バックエンドエンジニア |

### M3: Webフロントエンド実装と結合

| Task ID | タスク内容 | 担当者 |
| :--- | :--- | :--- |
| M3-T1 | HTML/CSSによるチャットUIの静的ページ作成 | フロントエンドエンジニア |
| M3-T2 | JS: `sessionStorage`による状態管理（state, user_info等）ロジック実装 | フロントエンドエンジニア |
| M3-T3 | JS: `/api/chat`への非同期通信とチャット描画ロジックの実装 | フロントエンドエンジニア |
| M3-T4 | 結合テスト（WebブラウザからバックエンドAPIを呼び出し、一連の対話が成立するか確認） | FE, バックエンドエンジニア |

### M4: 総合テストとパッケージング

| Task ID | タスク内容 | 担当者 |
| :--- | :--- | :--- |
| M4-T1 | 総合テストシナリオの作成と実施（正常系・異常系） | QAエンジニア |
| M4-T2 | 発見された不具合の修正と再テスト | FE, バックエンドエンジニア |
| M4-T3 | ユーザー受け入れテスト(UAT)の実施 | プロダクトマネージャー, QA |
| M4-T4 | アプリケーションの実行手順書（README）の作成 | プロダクトマネージャー |
| M4-T5 | PyInstaller等による実行可能ファイル化の検討と実装 | バックエンドエンジニア |

### M5: リリースと運用

| Task ID | タスク内容 | 担当者 |
| :--- | :--- | :--- |
| M5-T1 | リリース手順書に基づき、実行可能ファイルを配布 | プロダクトマネージャー |
| M5-T2 | リリース後の正常性確認テスト | QAエンジニア, PM |
| M5-T3 | 関係者へのリリース完了通知 | プロダクトマネージャー |
| M5-T4 | 運用マニュアル、FAQ等のドキュメント整備 | プロダクトマネージャー |

```

---

### 4. AI Agent向け指示書 (`CLAUDE.md`)

```markdown
# AI Agent 指示書 (CLAUDE.md)

**バージョン:** 1.2
**更新日時:** 2025.09.03
**対象プロジェクト:** デモ機予約管理Bot 開発

## 1. あなたの役割と目的

あなたは、本プロジェクトを担当する**開発AIエージェント**です。
あなたの目的は、与えられた設計書と計画書に基づき、「デモ機予約管理Bot」のソフトウェアを高品質に、かつルールを遵守して開発することです。

## 2. 厳守すべき最重要ルール

1.  **ドキュメント駆動開発の徹底**
    *   すべての機能実装は、`docs/design-specification.md` バージョン **5.0** の記述に**完全に準拠**してください。独自の仕様解釈や機能追加は禁止します。
    *   すべての作業は、`docs/project-plan.md` バージョン **4.0** に記載されたマイルストーンとタスクの順序に従って実行してください。

2.  **TodoWriteツールによる厳格なタスク管理**
    *   開発作業（コーディング、テスト、ドキュメント修正など）に着手する前には、必ず**TodoWriteツール**を使用して、該当タスクの`status`を`"in_progress"`に変更してください。
    *   タスクが完了したら、即座に**TodoWriteツール**を使用して`status`を`"completed"`に変更してください。
    *   **TodoWriteツールを使用しないタスクの実行は固く禁止します。**

3.  **品質保証プロセスの遵守**
    *   すべてのコーディングは、**TDD（テスト駆動開発）** の手順（Red → Green → Refactor）に従って実装してください。
    *   「共通開発ルール仕様書」に定められたコーディング規約を徹底してください。

## 3. 開発実行プロセス

これより、あなたのタスクを開始します。
`docs/project-plan.md` を参照し、最初のマイルストーン **M1** の最初のタスク **M1-T1** を特定してください。
**TodoWriteツール** を使用して、タスク **M1-T1** のステータスを `in_progress` に更新してください。
タスクを実行してください。
タスクが完了したら、ステータスを `completed` に更新し、その旨を報告してください。
その後、次のタスク **M1-T2** に進んでください。

上記プロセスを繰り返し、プロジェクトを計画通りに遂行してください。
では、最初のタスクを開始してください。
```