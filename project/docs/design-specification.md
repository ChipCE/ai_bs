
# デモ機予約管理Bot 設計書

**設計書バージョン:** 5.0
**バージョン名:** Chatbotステートマシン実装版
**更新日時:** 2025.09.03

## 1. システムアーキテクチャ

### 1.1. 概要
ユーザーのPC上で完結するWebアプリケーションを構築する。Chatbotの対話ロジックは、バックエンドのPythonサーバーに実装されたステートマシンによって管理される。フロントエンドは、現在の対話状態（State）を保持し、ユーザーの入力をサーバーに送信する役割を担う。

### 1.2. コンポーネント構成

```mermaid
graph TD
    subgraph "Local PC"
        subgraph "User Interface (Web Browser)"
            Frontend[HTML/CSS/JavaScript]
        end

        subgraph "Application Server"
            PythonServer[Python Web Server (Flask/FastAPI)]
        end

        subgraph "Data Storage"
            Excel[Local Excel File]
        end

        Frontend -- API Call (HTTP) --> PythonServer
        PythonServer -- Read/Write --> Excel
    end
```

### 1.3. データフロー
1.  **ユーザー**がWebブラウザでアプリケーションにアクセスします。
2.  **フロントエンドJS**は、`state`が`null`の状態でバックエンドの `POST /api/chat` へ最初のリクエストを送信します。
3.  **バックエンド**は、`state`が`null`であることを検知し、最初の挨拶と名前を尋ねる質問、そして次の状態 `AWAITING_USER_INFO_NAME` を返します。
4.  **フロントエンドJS**は、応答メッセージを画面に表示し、`state`を `AWAITING_USER_INFO_NAME` に更新して`sessionStorage`に保存します。
5.  **ユーザー**が名前を入力すると、**フロントエンドJS**は、保存しておいた`state`と入力された名前を付けて、再度 `POST /api/chat` へリクエストを送信します。
6.  **バックエンド**は、現在の`state`に応じた処理（この場合は内線番号を尋ねる処理）を行い、次の応答と`next_state`を返します。
7.  このプロセスを繰り返すことで、対話が進行します。

---

## 2. データモデル設計 (Excel)

*   **ファイル場所**: アプリケーションと同一階層の `data/` ディレクトリなど
*   **ファイル名**: `デモ機予約管理表.xlsx`

### 2.1. カレンダーシート
*   **シート名**: `yy年M月`形式 (例: `25年9月`, `25年10月`)
*   **テーブル化**: このシートは「テーブルとして書式設定」を使用しません。
*   **構造**:
    *   **日付ヘッダー (8行目)**: **C8セル**から右に向かって、月の日を記載 (`1`, `2`, `3`...)。
    *   **デモ機名リスト (B列)**: **B9セル**から下に向かって、デモ機名を記載。
    *   **予約データ領域**: **C9セル**から右下の範囲。デモ機（行）と日付（列）が交差するセルに予約フラグ"C"等を格納します。

### 2.2. 予約ログシート
*   **シート名**: `予約ログ`
*   **テーブル化**: このシートは扱いやすさのため、A1セルから始まる範囲をテーブルとして設定します。
*   **テーブル名**: `BookingLog`
*   **構造**:

| 列ヘッダ名 | データ型 | 説明 |
| :--- | :--- | :--- |
| 予約ID | 文字列 | 一意のID |
| 予約日時 | 文字列 | 日本時間(JST) `yyyy-MM-ddTHH:mm:ss` |
| **予約者名** | 文字列 | **ユーザーが入力した名前** |
| **内線番号** | 文字列 | **ユーザーが入力した内線番号** |
| **職番** | 文字列 | **ユーザーが入力した職番** |
| デモ機名 | 文字列 | 予約されたデモ機名 |
| 予約開始日| 日付 | `yyyy-MM-dd` |
| 予約終了日| 日付 | `yyyy-MM-dd` |
| ステータス | 文字列 | "予約中" |

---

## 3. API設計 (ローカルサーバー)

### 3.1. Chatbot対話API
すべての対話は、この単一のエンドポイントで処理される。

*   **エンドポイント:** `POST /api/chat`
*   **機能:** ユーザーの入力と現在の対話状態を受け取り、Botの応答と次の状態を返す。
*   **リクエストボディ (JSON):**
    ```json
    {
      "text": "FEデモ機を借りたい",    // ユーザーが入力したテキスト (初回はnull)
      "state": "AWAITING_COMMAND",    // フロントエンドが保持する現在の状態 (初回はnull)
      "user_info": {                  // フロントエンドが保持する入力済みのユーザー情報
        "name": "山田太郎",
        "extension": "1234",
        "employee_id": "56789"
      },
      "context": {} // 予約途中など、一時的な情報を保持するオブジェクト
    }
    ```
*   **レスポンスボディ (JSON):**
    ```json
    {
      "reply_text": "FEデモ機ですね。いつからいつまで利用しますか？", // Botの返信
      "next_state": "AWAITING_DATES", // 次の対話の状態
      "user_info": { ... }, // 更新されたユーザー情報
      "context": { "device_type": "FEデモ機" } // 更新された一時情報
    }
    ```

### 3.2. 内部ロジック
`POST /api/chat` は、内部的に以下のロジックモジュールを呼び出す。
*   Excel操作モジュール（在庫確認、予約実行、キャンセル実行）
*   自然言語解釈モジュール（ユーザーの入力から意図やキーワードを抽出）

---

## 4. フロントエンド設計

*   **UIコンポーネント:** チャット画面、入力欄、送信ボタン
*   **状態管理:**
    *   JavaScriptは、以下の情報を `sessionStorage` で永続化する。
        *   `state`: 現在の対話状態 (例: `AWAITING_COMMAND`)
        *   `user_info`: 入力済みのユーザー情報オブジェクト
        *   `context`: 予約途中のデモ機名など、一時的な情報
    *   ユーザーがメッセージを送信するたびに、これらの情報を `POST /api/chat` のリクエストに含める。
    *   APIからの応答を受け取ると、`sessionStorage` の情報をレスポンスの内容で更新する。

---

## 5. 開発環境
*   **言語:** Python 3.9+
*   **主要ライブラリ:** Flask, openpyxl, python-dotenv
*   **ツール:** pytest

```